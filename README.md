# rspt to spectra

This acts as an interface from the RSPt software to the [impurityModel](https://github.com/JohanSchott/impurityModel) spectra software.

This software contains a few Python modules that can be useful for parsing and analyzing RSPt output, and constructing an Anderson impurity Hamiltonian, including bath orbitals.
A few scripts are stored in the `scripts` folder.

Separately, in the module plotSpectra, a few functions for reading and plotting output from the Quanty software is provided.

## Usage 
### Preparations
- Add the parent path of the folder `rspt2spectra` to the `PYTHONPATH` variable:
```bash
export PYTHONPATH=${PYTHONPATH}:path/to/folder
```

- Optionally, for convienience add the absolute path of the sub directory `rspt2spectra/scripts` to the `PATH` environment variable. This enables the Python scripts to be found, without having to specify the absolute path to the scripts. If this is desired, add the following to the `~/.bashrc`:
 ```bash
 export PATH=$PATH:path/to/folder/rspt2spectra/scripts
 ```

### Example usage
- Move to the directory with the RSPt simulation of interest.
- Use Python scripts in the `scripts` folder to parse and analyze the RSPt simulation output data.
- Note that values generated by RSPt are in Rydberg but output from the scripts in this software are in eV.
- Obtained results can easily be passed on and used by the impurityModel software. 

Below follows steps for how to extract different parameters from an RSPt simulation.
In the impurityModel software there are a few example scripts. 
Please copy one of these scripts and replace the parameter values inside with the ones obtained using this software.

#### Slater-Condon integrals
In case the some of the correlated orbitals of interest are treated as core states in RSPt, 
first create a subdirectory in the simulation folder, containing a copy of the RSPt simulation directory.
In the subdiretory, move the core states into the valence energy set by modifiying the `data`-file.
Then, to make RSPt print Slater-Condon integrals, add a cluster in the `green.inp` containing the correlated orbitals of interest, e.g.:
```bash
# 3d and 2p of type 1
cluster
2 1 2 eV
1 2 1 1 0 -1.0 
1 1 3 1 0 -1.0
0 0 0.30
```
Also add the following to the `green.inp`:
```bash
verbose
Umatrix

debug
Noscreening
```
In the subdirectory, the correlated orbitals of interest should now be in RSPt's valence basis. 
Now run RSPt only once. 
The Slater-Condon intergral values are printed to the `out`-file and can be found by grepping for `Slater parameters`. 
Convert them to eV and insert them in your impurityModel script.


#### SOC parameters
The SOC parameters are printed in the RSPt generated `out`-file.

For orbitals which are treated as core states in RSPt, the orbital energy difference is found by grepping for the keyword `core states`.
From this difference we can extract the SOC parameter. E.g. for 2p orbitals, the energy difference is equal to 3/2 times the SOC parameter.
Convert the value to eV and insert it in your impurityModel script.

For orbitals which are treated as valence states in RSPt, the SOC parameter can be extracted if the `data`-file has the keyword `f-rel` set to `t` (true). 
If `f-rel` is set to `f` (false) in your simulation folder, create a subdirectory, copy the simulations files there, and in the subdirectory change the `f-rel` flag to `t`.

Also a `green.inp` is needed with a cluster of the orbitals of interest. 
The non-interacting local Hamiltonian is found by grepping for the keyword `Local hamiltonian`.
The SOC parameter is equal to the (2,6)-element if spherical harmonics are used.
Again, convert the value to eV and insert it in your impurityModel script.


#### Choose convenient orbitals
For the hybridization and the on-site energies of the impurity, the choice of orbitals matter. 
One good approach is to find a RSPt basis for the correlated orbitals which diagonalizes the local non-interacting Hamiltonian. 
In high-symmetry cases, this will also diagonalize the hybridization function, which makes the discretization of the hybridzation function much easier. 
E.g. with cubic environment (Oh symmetry), the orbitals of choice are the cubic harmonics. 
Cubic harmonics are selected by using the basis index `3` in the `green.inp`-file.

Another approach to obtain a diagonalized non-interacting local Hamiltonian is to use RSPt's projection files. 
If one does not know which orbitals will generate a diagonal non-interacting local Hamiltonian, 
one can start with a spherical harmonics basis (basis index `0`) in `green.inp` and run one iteration with `rspt`. 
Then execute the Python script from this software:
```bash
diagonalize_local_H0.py 
```
If the RSPt calculations are spin-polarized, type instead:
```bash
diagonalize_local_H0.py spinpol
```
This will generate a projection file for each cluster in the `green.inp`-file.
Now add a new cluster in `green.inp` which will read the projection-file for the orbitals you want to rotate. 
For example, if the d-orbitals in atom type 1 is of interest, the new cluster may look like this:
```bash
cluster
1 0 Irr1    ! ntot udef [nsites]
1 2 1 1 0   ! t l e site basis, U J or F0 F2 F4 (F6)
```
To generate projected density of states (PDOS) and hybridization functions from RSPt, also add the block
```bash
spectrum
Dos Hyb
```
to the `green.inp`-file and run `rspt` once more. 

In the new `out`-file, the new cluster should have a diagonal local non-interacting Hamiltonian (grep for `Local hamiltonian`).

In the following, we assume a diagonalized basis is used.

#### Discretize hybridization functions and adjust on-site energies

Copy the input file `rspt2spectra_parameters.py` from the `input_settings` folder to the simulation folder.
Edit it to your purpose, e.g. choose the number of bath states to have. 
Execute the script `finiteH0.py`:
```bash
finiteH0.py
```
This script will read the PDOS and the hybridization function and print the non-relativistic non-interacting Hamiltonian to disk.
Move the created file to an empty simulation folder.
Make sure your impurityModel script reads the file, and also contains the other parameters (e.g. SOC).
Finally, execute your impurityModel script. E.g. if the script is called `Ni_NiO_3bath.py`, type:
```bash
Ni_NiO_3bath.py
```
After this, you should have the spectra you wanted.

### Documentation
The documentation of this package is found in the directory `docs`.

To update the manual, go to directory `docs` and simply type:

```
make html
```
to generate a html-page.
To instead generate a pdf-file, type:
```
make latex
```
and follow the instructions.

Note:
- package `numpydoc` is required. If missing, e.g. type `conda install numpydoc` 
- If a new module or subpackage is created, this information needs to be added to `docs/index.rst`. 

